openapi: 3.1.0
info:
  title: VueFinder API
  description: |
    File management API for VueFinder using query-based routing.
    
    All operations are performed through a single endpoint with the operation specified 
    via the 'q' query parameter (e.g., ?q=index, ?q=upload, ?q=delete).
  version: 1.0.0
servers:
  - url: /api
    description: API server

tags:
  - name: Directory Operations
    description: Operations for browsing and managing directories
  - name: File Operations
    description: Operations for creating, modifying, and deleting files and folders
  - name: File Content
    description: Operations for reading and writing file content
  - name: Archive Operations
    description: Operations for creating and extracting ZIP archives

components:
  schemas:
    Adapter:
      type: string
      description: Storage adapter key
      example: 'local'
    
    Path:
      type: string
      description: Full path with adapter prefix
      example: 'local://documents/report.pdf'
    
    DirectoryPath:
      type: string
      description: Directory path with adapter prefix
      example: 'local://documents'
      default: 'adapter://'
    
    Basename:
      type: string
      description: Base name of the file or directory (extracted via basename() function)
      example: 'report.pdf'
    
    Name:
      type: string
      description: Name that must not contain \/?%*:|"<> characters
      pattern: '^[^\\/?%*:|"<>]+$'
      example: 'new-document.txt'
    
    Extension:
      type: string
      description: File extension without the dot (extracted via pathinfo)
      example: 'pdf'
    
    MimeType:
      type: string
      description: MIME type of the file (detected by filesystem)
      example: 'application/pdf'
    
    Url:
      type: string
      format: uri
      description: Public URL to access the file
      example: 'https://cdn.example.com/documents/report.pdf'
    
    FileSize:
      type: integer
      format: int64
      minimum: 0
      description: File size in bytes (provided by filesystem StorageAttributes)
      example: 1048576
    
    Timestamp:
      type: integer
      format: int64
      description: Unix timestamp
      example: 1698364800
    
    FileType:
      type: string
      enum: [file, dir]
      description: Type of the node - 'file' for files, 'dir' for directories
    
    AdapterList:
      type: array
      items:
        $ref: '#/components/schemas/Adapter'
      description: List of all available storage adapter keys configured in the system
      example: ['local', 's3', 'ftp']
    
    FileList:
      type: array
      items:
        $ref: '#/components/schemas/FileNode'
      description: Array of files and directories (directories listed first, then files)
    
    FolderList:
      type: array
      items:
        $ref: '#/components/schemas/Folder'
      description: Array of folders
    
    FileItemList:
      type: array
      description: Array of items for batch operations
      minItems: 1
      items:
        $ref: '#/components/schemas/FileItem'
    
    FileContent:
      type: string
      description: Text content of a file
      example: 'Hello, world!'
    
    ArchiveName:
      type: string
      description: Archive name without extension (pathinfo PATHINFO_FILENAME extracts this, .zip added automatically)
      pattern: '^[^\\/?%*:|"<>]+$'
      example: 'backup-2024'
    
    SearchFilter:
      type: string
      description: Search filter/pattern (case-insensitive, uses fnmatch with wildcards)
      minLength: 1
      example: 'report'
    
    FileNode:
      type: object
      description: Represents a file or directory in the file system
      required:
        - path
        - type
        - basename
        - storage
      properties:
        path:
          $ref: '#/components/schemas/Path'
        type:
          $ref: '#/components/schemas/FileType'
        basename:
          $ref: '#/components/schemas/Basename'
        extension:
          $ref: '#/components/schemas/Extension'
        storage:
          $ref: '#/components/schemas/Adapter'
        mime_type:
          $ref: '#/components/schemas/MimeType'
        url:
          $ref: '#/components/schemas/Url'
        file_size:
          $ref: '#/components/schemas/FileSize'
        last_modified:
          $ref: '#/components/schemas/Timestamp'
        dir:
          $ref: '#/components/schemas/DirectoryPath'
            
    FileItem:
      type: object
      description: Reference to a file or directory for batch operations (move, delete, archive)
      required:
        - path
        - type
      properties:
        path:
          $ref: '#/components/schemas/Path'
        type:
          $ref: '#/components/schemas/FileType'
    
    Folder:
      type: object
      description: Subfolder information for tree navigation
      required:
        - adapter
        - path
        - basename
      properties:
        adapter:
          $ref: '#/components/schemas/Adapter'
        path:
          $ref: '#/components/schemas/Path'
        basename:
          $ref: '#/components/schemas/Basename'
    
    DirectoryListingResponse:
      type: object
      description: |
        Standard response containing directory contents and metadata.
        
        The 'adapter' field indicates which adapter was used for this response. When clients 
        make their first request without specifying an adapter parameter (or with adapter=null), 
        this field will contain the first configured adapter, allowing clients to discover and 
        use it for subsequent requests. The 'storages' array contains all available adapters.
      required:
        - adapter
        - storages
        - dirname
        - files
      properties:
        adapter:
          $ref: '#/components/schemas/Adapter'
        storages:
          $ref: '#/components/schemas/AdapterList'
        dirname:
          $ref: '#/components/schemas/DirectoryPath'
        files:
          $ref: '#/components/schemas/FileList'
    
    SubfoldersResponse:
      type: object
      required:
        - folders
      properties:
        folders:
          $ref: '#/components/schemas/FolderList'
    
    CreateRequest:
      type: object
      description: Request to create a new file or folder (name validated against \\/?%*:|"<> characters)
      required:
        - name
      properties:
        name:
          $ref: '#/components/schemas/Name'
    
    RenameRequest:
      type: object
      required:
        - name
        - item
      properties:
        name:
          $ref: '#/components/schemas/Name'
        item:
          $ref: '#/components/schemas/Path'
    
    MoveRequest:
      type: object
      required:
        - item
        - items
      properties:
        item:
          $ref: '#/components/schemas/DirectoryPath'
        items:
          $ref: '#/components/schemas/FileItemList'
    
    DeleteRequest:
      type: object
      required:
        - items
      properties:
        items:
          $ref: '#/components/schemas/FileItemList'
    
    ArchiveRequest:
      type: object
      required:
        - name
        - items
      properties:
        name:
          $ref: '#/components/schemas/ArchiveName'
        items:
          $ref: '#/components/schemas/FileItemList'
    
    UnarchiveRequest:
      type: object
      required:
        - item
      properties:
        item:
          $ref: '#/components/schemas/Path'
    
    SaveRequest:
      type: object
      required:
        - content
      properties:
        content:
          $ref: '#/components/schemas/FileContent'
    
    UploadSuccessResponse:
      type: array
      items:
        type: string
        enum: [ok]
      minItems: 1
      maxItems: 1
      example: ["ok"]
    
    ErrorResponse:
      type: object
      description: Standard error response returned with 400 status code
      required:
        - status
        - message
      properties:
        status:
          type: boolean
          enum: [false]
          description: Always false for error responses
          example: false
        message:
          type: string
          description: Human-readable error message describing what went wrong
          example: 'Invalid folder name.'

  responses:
    DirectoryListing:
      description: Directory contents with files and folders
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/DirectoryListingResponse'
    
    Subfolders:
      description: List of folders
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SubfoldersResponse'
    
    UploadSuccess:
      description: Upload successful
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/UploadSuccessResponse'
    
    BinaryFile:
      description: File content streamed as binary data
      headers:
        Content-Type:
          schema:
            $ref: '#/components/schemas/MimeType'
          description: MIME type of the file (detected by filesystem or 'application/octet-stream')
        Content-Length:
          schema:
            $ref: '#/components/schemas/FileSize'
          description: Size of file in bytes
        Accept-Ranges:
          schema:
            type: string
            enum: [bytes]
          description: Indicates server supports range requests
      content:
        application/octet-stream:
          schema:
            type: string
            format: binary
    
    PartialContent:
      description: Partial content for HTTP range requests (status 206)
      headers:
        Content-Type:
          schema:
            $ref: '#/components/schemas/MimeType'
          description: MIME type of the file
        Content-Length:
          schema:
            $ref: '#/components/schemas/FileSize'
          description: Size of the partial content being sent
      content:
        application/octet-stream:
          schema:
            type: string
            format: binary
    
    FileDownload:
      description: File download with attachment disposition
      headers:
        Content-Disposition:
          schema:
            type: string
          description: Attachment header with filename (uses MD5 hash as fallback for special characters)
          example: 'attachment; filename="report.pdf"'
      content:
        application/octet-stream:
          schema:
            type: string
            format: binary
    
    Error:
      description: Error response with status false and error message
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  parameters:
    operation:
      name: q
      in: query
      required: true
      description: |
        Operation to perform. This parameter routes the request to the appropriate handler method.
        
        Valid operations and their HTTP methods:
        - GET: index, subfolders, download, preview, search
        - POST: newfolder, newfile, rename, move, delete, upload, archive, unarchive, save
      schema:
        type: string
        enum:
          - index
          - subfolders
          - download
          - preview
          - search
          - newfolder
          - newfile
          - rename
          - move
          - delete
          - upload
          - archive
          - unarchive
          - save
      example: index
    
    adapter:
      name: adapter
      in: query
      description: |
        Storage adapter key to use. Optional parameter that allows clients to specify which storage adapter to use.
        
        Behavior:
        - If omitted or null: Server returns the first configured adapter in the response, allowing clients to discover available adapters
        - If provided but invalid: Server returns the first configured adapter (fallback behavior)
        - If provided and valid: Server uses the specified adapter
        
        This allows clients to start with adapter=null, receive the adapter list in the response, 
        and then use a specific adapter in subsequent requests.
      required: false
      schema:
        $ref: '#/components/schemas/Adapter'

paths:
  /:
    options:
      summary: CORS preflight
      description: Handle CORS preflight requests for all operations
      responses:
        '200':
          description: CORS headers set
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
                example: "*"
            Access-Control-Allow-Headers:
              schema:
                type: string
                example: "*"
    
    get:
      summary: Execute read operations
      description: |
        Main endpoint for all GET operations (read-only). The specific operation is determined 
        by the 'q' query parameter.
        
        Supported operations:
        - **index**: List directory contents
        - **subfolders**: List immediate subdirectories
        - **search**: Search files recursively by name
        - **preview**: Stream file content for preview
        - **download**: Download file with attachment disposition
      parameters:
        - $ref: '#/components/parameters/operation'
        - $ref: '#/components/parameters/adapter'
        - name: path
          in: query
          required: false
          description: |
            Directory or file path with adapter prefix. Required for some operations.
            - For index/subfolders/search: Directory path (defaults to 'adapter://')
            - For preview/download: Full file path (required)
          schema:
            type: string
          examples:
            directory:
              value: 'local://documents'
              summary: Directory path
            file:
              value: 'local://documents/report.pdf'
              summary: File path
        - name: filter
          in: query
          required: false
          description: Search filter (required when q=search). Case-insensitive, uses fnmatch with wildcards.
          schema:
            $ref: '#/components/schemas/SearchFilter'
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/DirectoryListingResponse'
                  - $ref: '#/components/schemas/SubfoldersResponse'
              examples:
                indexResponse:
                  summary: Response for q=index
                  value:
                    adapter: local
                    storages: [local, s3]
                    dirname: local://documents
                    files:
                      - path: local://documents/report.pdf
                        type: file
                        basename: report.pdf
                        extension: pdf
                        storage: local
                        mime_type: application/pdf
                subfoldersResponse:
                  summary: Response for q=subfolders
                  value:
                    folders:
                      - adapter: local
                        path: local://documents/archive
                        basename: archive
            application/octet-stream:
              schema:
                type: string
                format: binary
                description: Binary file content (for q=preview or q=download)
        '206':
          description: Partial content (for HTTP range requests on preview/download)
          headers:
            Content-Type:
              schema:
                $ref: '#/components/schemas/MimeType'
            Content-Length:
              schema:
                $ref: '#/components/schemas/FileSize'
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/Error'
    
    post:
      summary: Execute write operations
      description: |
        Main endpoint for all POST operations (write/modify). The specific operation is 
        determined by the 'q' query parameter.
        
        Supported operations:
        - **newfolder**: Create a new directory
        - **newfile**: Create a new empty file
        - **upload**: Upload file content
        - **save**: Save/update file content
        - **rename**: Rename a file or folder
        - **move**: Move files/folders to new location
        - **delete**: Delete files/folders
        - **archive**: Create ZIP archive from files/folders
        - **unarchive**: Extract ZIP archive
        
        Note: These operations are blocked if the adapter is read-only.
      parameters:
        - $ref: '#/components/parameters/operation'
        - $ref: '#/components/parameters/adapter'
        - name: path
          in: query
          required: true
          description: |
            Directory or file path with adapter prefix.
            - For newfolder/newfile/upload/move/delete/archive/unarchive: Directory path where operation occurs
            - For save/rename: Full path to the file
          schema:
            type: string
          examples:
            directory:
              value: 'local://documents'
            file:
              value: 'local://documents/notes.txt'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CreateRequest'
                - $ref: '#/components/schemas/RenameRequest'
                - $ref: '#/components/schemas/MoveRequest'
                - $ref: '#/components/schemas/DeleteRequest'
                - $ref: '#/components/schemas/ArchiveRequest'
                - $ref: '#/components/schemas/UnarchiveRequest'
                - $ref: '#/components/schemas/SaveRequest'
            examples:
              newfolder:
                summary: Create folder (q=newfolder)
                value:
                  name: "2024-reports"
              newfile:
                summary: Create file (q=newfile)
                value:
                  name: "notes.txt"
              rename:
                summary: Rename (q=rename)
                value:
                  item: "local://documents/old-name.txt"
                  name: "new-name.txt"
              move:
                summary: Move files (q=move)
                value:
                  item: "local://archive"
                  items:
                    - path: "local://documents/file1.txt"
                      type: file
              delete:
                summary: Delete files (q=delete)
                value:
                  items:
                    - path: "local://temp/old-file.txt"
                      type: file
              archive:
                summary: Create archive (q=archive)
                value:
                  name: "backup-2024"
                  items:
                    - path: "local://documents/file1.pdf"
                      type: file
              unarchive:
                summary: Extract archive (q=unarchive)
                value:
                  item: "local://downloads/backup.zip"
              save:
                summary: Save file content (q=save)
                value:
                  content: "Updated file content..."
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - name
              properties:
                file:
                  type: string
                  format: binary
                  description: File data to upload
                name:
                  type: string
                  description: Target filename
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/DirectoryListingResponse'
                  - $ref: '#/components/schemas/UploadSuccessResponse'
              examples:
                directoryListing:
                  summary: Most operations return updated directory listing
                  value:
                    adapter: local
                    storages: [local]
                    dirname: local://documents
                    files: []
                uploadSuccess:
                  summary: Upload returns simple success (q=upload)
                  value: ["ok"]
            application/octet-stream:
              schema:
                type: string
                format: binary
                description: Binary file content (for q=save, returns file via preview)
        '400':
          $ref: '#/components/responses/Error'
