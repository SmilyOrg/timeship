openapi: 3.1.0
info:
  title: VueFinder API v2 (RESTful Edition)
  description: |
    RESTful file management API using unified node concept.
    
    All filesystem objects (files and directories) are treated as "nodes" with a type field.
    This mirrors the Unix/Linux filesystem philosophy where everything is an inode.
    
    Key concepts:
    - Nodes are identified by their path (compound key with slashes)
    - Node type (file/dir) is determined by the response, not the URL
    - Paths are hierarchical and natural - empty path = storage root
    - Operations are RESTful resources (moves, copies, archives)
  version: 2.0.0
  
servers:
  - url: /api/
    description: API v2 server

tags:
  - name: Storages
    description: Storage backend discovery and management
  - name: Nodes
    description: Unified file and directory operations
  - name: Moves
    description: Move operations on nodes
  - name: Copies
    description: Copy operations on nodes
  - name: Archives
    description: Archive creation and extraction

components:
  schemas:
    NodeType:
      type: string
      enum: [file, dir]
      description: Type of the filesystem node
      
    Node:
      type: object
      description: |
        Unified representation of any filesystem object (file or directory).
        Inspired by Unix inode concept where everything is a node with attributes.
      required:
        - path
        - type
        - basename
        - storage
      properties:
        path:
          type: string
          description: Full path with adapter prefix
          example: 'local://documents/reports/2024/report.pdf'
        type:
          $ref: '#/components/schemas/NodeType'
        basename:
          type: string
          description: Base name of the node
          example: 'report.pdf'
        storage:
          type: string
          description: Storage adapter identifier
          example: 'local'
        extension:
          type: string
          description: File extension (only for files)
          example: 'pdf'
        mime_type:
          type: string
          description: MIME type (only for files)
          example: 'application/pdf'
        file_size:
          type: integer
          format: int64
          description: Size in bytes (only for files)
          example: 1048576
        last_modified:
          type: integer
          format: int64
          description: Unix timestamp of last modification
          example: 1698364800
        dir:
          type: string
          description: Parent directory path with adapter prefix
          example: 'local://documents/reports/2024'
        permissions:
          type: object
          description: Node permissions
          properties:
            readable:
              type: boolean
            writable:
              type: boolean
            executable:
              type: boolean
        children:
          type: array
          description: Child nodes (only present for directories when listing)
          items:
            $ref: '#/components/schemas/Node'
            
    NodeList:
      type: object
      description: Response containing list of nodes
      required:
        - adapter
        - storage
        - storages
        - dirname
        - files
      properties:
        adapter:
          type: string
          description: Current storage adapter
          example: 'local'
        storage:
          type: string
          description: Current storage adapter
          example: 'local'
        storages:
          type: array
          description: Available storage adapters
          items:
            type: string
          example: ['local', 's3', 'minio']
        dirname:
          type: string
          description: Current directory path with adapter prefix
          example: 'local://documents/reports'
        path:
          type: string
          description: Current directory path without adapter prefix
          example: 'documents/reports'
        files:
          type: array
          description: Child nodes
          items:
            $ref: '#/components/schemas/Node'
    
    CreateNodeRequest:
      type: object
      required:
        - name
        - type
      properties:
        name:
          type: string
          pattern: '^[^\\/?%*:|"<>]+$'
          description: Name of the node to create
          example: 'new-folder'
        type:
          $ref: '#/components/schemas/NodeType'
        content:
          type: string
          description: Initial content (only for files)
          
    UpdateNodeRequest:
      type: object
      properties:
        name:
          type: string
          pattern: '^[^\\/?%*:|"<>]+$'
          description: New name for the node (rename)
        content:
          type: string
          description: Updated content (only for files)
          
    BatchOperationRequest:
      type: object
      required:
        - operation
        - items
      properties:
        operation:
          type: string
          enum: [move, copy, delete]
        destination:
          type: string
          description: Destination path (required for move/copy)
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - path
            properties:
              path:
                type: string
              type:
                $ref: '#/components/schemas/NodeType'
                
    ArchiveRequest:
      type: object
      required:
        - name
        - items
      properties:
        name:
          type: string
          pattern: '^[^\\/?%*:|"<>]+$'
          description: Archive name (without .zip extension)
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - path
            properties:
              path:
                type: string
                
    ExtractRequest:
      type: object
      properties:
        destination:
          type: string
          description: Destination path (defaults to archive location)
          
    ErrorResponse:
      type: object
      required:
        - status
        - message
      properties:
        status:
          type: boolean
          enum: [false]
          description: Always false for error responses
          example: false
        message:
          type: string
          description: Human-readable error message
          example: 'Invalid node name.'

  parameters:
    storage:
      name: storage
      in: path
      required: true
      schema:
        type: string
      description: Storage backend identifier
      example: local
      
    nodePath:
      name: path...
      in: path
      required: true
      schema:
        type: string
      style: simple
      allowReserved: true
      description: |
        Node path (can contain slashes). Path is relative to storage root.
        Use empty string or single space for storage root.
        
        Note: OpenAPI path parameters cannot be truly optional, but empty string 
        is supported by the router. The spec uses '*' suffix to match everything 
        including empty paths.
      examples:
        root:
          value: " "
          summary: Storage root (use space in spec, empty in actual URLs)
        file:
          value: "documents/report.pdf"
          summary: File path
        directory:
          value: "documents/reports/2024"
          summary: Directory path
          
    getNodesType:
      name: type
      in: query
      schema:
        $ref: '#/components/schemas/NodeType'
      description: Filter children by type (for directories)
      
    getNodesFilter:
      name: filter
      in: query
      schema:
        type: string
      description: Filename pattern (glob-style, e.g., *.pdf)
      example: '*.pdf'
      
    getNodesSearch:
      name: search
      in: query
      schema:
        type: string
      description: Search query - searches recursively from this path
      example: 'report'
      
    getNodesChildren:
      name: children
      in: query
      schema:
        type: boolean
        default: true
      description: Include children in response (for directories)
      
    getNodesDownload:
      name: download
      in: query
      schema:
        type: boolean
        default: false
      description: Set Content-Disposition to attachment (for files)
      
    getNodesSort:
      name: sort
      in: query
      schema:
        type: string
        enum: [name, size, modified_at, type]
      description: Sort field for children
      
    getNodesOrder:
      name: order
      in: query
      schema:
        type: string
        enum: [asc, desc]
        default: asc
      description: Sort order
      
    deleteNodesRecursive:
      name: recursive
      in: query
      schema:
        type: boolean
        default: true
      description: Delete recursively (for directories)
      
  responses:
    nodeSuccess200:
      description: Node information or content
      headers:
        Content-Type:
          schema:
            type: string
          description: Response content type
        Content-Disposition:
          schema:
            type: string
          description: Disposition header (for file downloads)
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/Node'
              - $ref: '#/components/schemas/NodeList'
          examples:
            directory:
              summary: Directory listing
              value:
                adapter: local
                storage: local
                storages: [local, s3]
                dirname: local://documents
                path: documents
                files:
                  - path: local://documents/reports
                    type: dir
                    basename: reports
                    storage: local
                    last_modified: 1698364800
                    dir: local://documents
                  - path: local://documents/readme.txt
                    type: file
                    basename: readme.txt
                    storage: local
                    extension: txt
                    mime_type: text/plain
                    file_size: 1024
                    last_modified: 1698364800
                    dir: local://documents
            file:
              summary: File metadata
              value:
                path: local://documents/report.pdf
                type: file
                basename: report.pdf
                storage: local
                extension: pdf
                mime_type: application/pdf
                file_size: 1048576
                last_modified: 1698364800
                dir: local://documents
            search:
              summary: Search results
              value:
                adapter: local
                storage: local
                storages: [local, s3]
                dirname: local://documents
                path: documents
                files:
                  - path: local://documents/2024/report.pdf
                    type: file
                    basename: report.pdf
                    storage: local
                  - path: local://documents/reports/annual-report.pdf
                    type: file
                    basename: annual-report.pdf
                    storage: local
        application/octet-stream:
          schema:
            type: string
            format: binary
        text/plain:
          schema:
            type: string
            
    nodeCreated201:
      description: Node created successfully
      headers:
        Location:
          schema:
            type: string
          description: URL to the created node
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Node'
            
    nodeNotFound404:
      description: Node not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
            
    badRequest400:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
            
    nodeConflict409:
      description: Node already exists
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

paths:
  /storages:
    get:
      summary: List available storage backends
      tags: [Storages]
      responses:
        '200':
          description: List of available storages
          content:
            application/json:
              schema:
                type: object
                properties:
                  storages:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        type:
                          type: string
                          enum: [local, s3, ftp, webdav]
                        writable:
                          type: boolean
              example:
                storages:
                  - id: local
                    name: Local Storage
                    type: local
                    writable: true
                  - id: s3
                    name: AWS S3
                    type: s3
                    writable: true

  /storages/{storage}/nodes:
    parameters:
      - $ref: '#/components/parameters/storage'
      
    get:
      summary: Get storage root information or content
      description: |
        Get information about storage root, or its content if accessible as a file.
        This is a convenience endpoint for accessing the root without a path parameter.
        
        For storage roots: Returns root metadata and lists children.
        
        Content negotiation:
        - Accept: application/json → Returns node metadata
        - Accept: application/octet-stream → Returns file content (binary)
        - Accept: text/* → Returns file content (text)
      tags: [Nodes]
      parameters:
        - $ref: '#/components/parameters/getNodesType'
        - $ref: '#/components/parameters/getNodesFilter'
        - $ref: '#/components/parameters/getNodesSearch'
        - $ref: '#/components/parameters/getNodesChildren'
        - $ref: '#/components/parameters/getNodesDownload'
        - $ref: '#/components/parameters/getNodesSort'
        - $ref: '#/components/parameters/getNodesOrder'
      responses:
        '200':
          $ref: '#/components/responses/nodeSuccess200'
        '404':
          $ref: '#/components/responses/nodeNotFound404'
                
    post:
      summary: Create a new child node at storage root
      description: |
        Create a new file or directory at the storage root.
      tags: [Nodes]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNodeRequest'
            examples:
              directory:
                summary: Create directory
                value:
                  name: "2024-reports"
                  type: dir
              file:
                summary: Create file with content
                value:
                  name: "notes.txt"
                  type: file
                  content: "Hello, world!"
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload
                name:
                  type: string
                  description: Optional custom filename (defaults to uploaded filename)
      responses:
        '201':
          $ref: '#/components/responses/nodeCreated201'
        '400':
          $ref: '#/components/responses/badRequest400'
        '409':
          $ref: '#/components/responses/nodeConflict409'

  /storages/{storage}/nodes/{path...}:
    parameters:
      - $ref: '#/components/parameters/storage'
      - $ref: '#/components/parameters/nodePath'
      
    get:
      summary: Get node information or content
      description: |
        Get information about a node, or its content if it's a file.
        Works for both storage root (empty path) and nested paths.
        
        For directories: Returns node metadata and lists children.
        For files: Returns file content (use Accept header for format).
        
        Content negotiation:
        - Accept: application/json → Returns node metadata
        - Accept: application/octet-stream → Returns file content (binary)
        - Accept: text/* → Returns file content (text)
      tags: [Nodes]
      parameters:
        - $ref: '#/components/parameters/getNodesType'
        - $ref: '#/components/parameters/getNodesFilter'
        - $ref: '#/components/parameters/getNodesSearch'
        - $ref: '#/components/parameters/getNodesChildren'
        - $ref: '#/components/parameters/getNodesDownload'
        - $ref: '#/components/parameters/getNodesSort'
        - $ref: '#/components/parameters/getNodesOrder'
      responses:
        '200':
          $ref: '#/components/responses/nodeSuccess200'
        '404':
          $ref: '#/components/responses/nodeNotFound404'
                
    post:
      summary: Create a new child node
      description: |
        Create a new file or directory as a child of this path.
        For storage root, creates at root level.
      tags: [Nodes]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNodeRequest'
            examples:
              directory:
                summary: Create directory
                value:
                  name: "2024-reports"
                  type: dir
              file:
                summary: Create file with content
                value:
                  name: "notes.txt"
                  type: file
                  content: "Hello, world!"
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload
                name:
                  type: string
                  description: Optional custom filename (defaults to uploaded filename)
      responses:
        '201':
          $ref: '#/components/responses/nodeCreated201'
        '400':
          $ref: '#/components/responses/badRequest400'
        '409':
          $ref: '#/components/responses/nodeConflict409'
                
    patch:
      summary: Update node metadata or content
      description: |
        Update node name (rename) or content (for files).
        Partial updates are supported.
      tags: [Nodes]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateNodeRequest'
            examples:
              rename:
                summary: Rename node
                value:
                  name: "new-name.pdf"
              updateContent:
                summary: Update file content
                value:
                  content: "Updated content..."
      responses:
        '200':
          description: Node updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
        '404':
          description: Node not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
                
    delete:
      summary: Delete a node
      description: |
        Delete a file or directory.
        For directories, all children are deleted recursively by default.
      tags: [Nodes]
      parameters:
        - $ref: '#/components/parameters/deleteNodesRecursive'
      responses:
        '204':
          description: Node deleted successfully
        '404':
          $ref: '#/components/responses/nodeNotFound404'
        '409':
          description: Directory not empty and recursive=false
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /storages/{storage}/moves:
    parameters:
      - $ref: '#/components/parameters/storage'
      
    post:
      summary: Move nodes to a new location
      description: |
        Move one or more nodes to a different location.
        This is a batch operation that can move multiple items atomically.
      tags: [Moves]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - destination
                - items
              properties:
                destination:
                  type: string
                  description: Destination path (relative to storage root)
                  example: "archive/2024"
                items:
                  type: array
                  minItems: 1
                  description: Nodes to move
                  items:
                    type: object
                    required:
                      - path
                    properties:
                      path:
                        type: string
                        description: Source path
                      type:
                        $ref: '#/components/schemas/NodeType'
            example:
              destination: archive/2024
              items:
                - path: documents/report1.pdf
                  type: file
                - path: documents/report2.pdf
                  type: file
                - path: documents/old-folder
                  type: dir
      responses:
        '200':
          description: Move operation completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  moved:
                    type: integer
                    description: Number of nodes moved
                  destination:
                    type: string
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        source:
                          type: string
                        destination:
                          type: string
                        status:
                          type: string
                          enum: [success, failed]
                        error:
                          type: string
              example:
                moved: 3
                destination: local://archive/2024
                results:
                  - source: local://documents/report1.pdf
                    destination: local://archive/2024/report1.pdf
                    status: success
                  - source: local://documents/report2.pdf
                    destination: local://archive/2024/report2.pdf
                    status: success
                  - source: local://documents/old-folder
                    destination: local://archive/2024/old-folder
                    status: success
        '207':
          description: Multi-status (partial success)
          content:
            application/json:
              schema:
                type: object
                properties:
                  moved:
                    type: integer
                  failed:
                    type: integer
                  results:
                    type: array
                    items:
                      type: object
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /storages/{storage}/copies:
    parameters:
      - $ref: '#/components/parameters/storage'
      
    post:
      summary: Copy nodes to a new location
      description: |
        Copy one or more nodes to a different location.
        Original nodes remain unchanged.
      tags: [Copies]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - destination
                - items
              properties:
                destination:
                  type: string
                  description: Destination path
                items:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required:
                      - path
                    properties:
                      path:
                        type: string
                      type:
                        $ref: '#/components/schemas/NodeType'
            example:
              destination: backup/2024
              items:
                - path: documents/important.pdf
                  type: file
      responses:
        '200':
          description: Copy operation completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  copied:
                    type: integer
                  destination:
                    type: string
                  results:
                    type: array
                    items:
                      type: object
              example:
                copied: 1
                destination: local://backup/2024
                results:
                  - source: local://documents/important.pdf
                    destination: local://backup/2024/important.pdf
                    status: success
        '207':
          description: Multi-status (partial success)
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /storages/{storage}/archives:
    parameters:
      - $ref: '#/components/parameters/storage'
      
    post:
      summary: Create a ZIP archive from nodes
      description: |
        Create a ZIP archive containing specified nodes.
        The archive is created as a new file node.
      tags: [Archives]
      parameters:
        - name: path
          in: query
          schema:
            type: string
          description: Destination directory for archive (defaults to storage root)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - items
              properties:
                name:
                  type: string
                  pattern: '^[^\\/?%*:|"<>]+$'
                  description: Archive name (without .zip extension)
                  example: "backup-2024"
                items:
                  type: array
                  minItems: 1
                  description: Nodes to include in archive
                  items:
                    type: object
                    required:
                      - path
                    properties:
                      path:
                        type: string
                      type:
                        $ref: '#/components/schemas/NodeType'
            example:
              name: backup-2024-11
              items:
                - path: documents/report1.pdf
                  type: file
                - path: documents/reports
                  type: dir
      responses:
        '201':
          description: Archive created
          headers:
            Location:
              schema:
                type: string
              description: URL to the created archive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
              example:
                path: local://backup-2024-11.zip
                type: file
                basename: backup-2024-11.zip
                storage: local
                extension: zip
                mime_type: application/zip
                file_size: 2097152
                last_modified: 1698364800
                dir: local://
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
                
    get:
      summary: List all archives
      description: |
        List all ZIP archives in the storage.
        This is a convenience endpoint that filters nodes by .zip extension.
      tags: [Archives]
      parameters:
        - name: path
          in: query
          schema:
            type: string
          description: Directory to search (searches recursively)
      responses:
        '200':
          description: List of archives
          content:
            application/json:
              schema:
                type: object
                properties:
                  archives:
                    type: array
                    items:
                      $ref: '#/components/schemas/Node'

  /storages/{storage}/archives/{path}:
    parameters:
      - $ref: '#/components/parameters/storage'
      - name: path
        in: path
        required: true
        schema:
          type: string
        style: simple
        description: Path to the archive file
        
    post:
      summary: Extract a ZIP archive
      description: |
        Extract the contents of a ZIP archive.
        Creates an extraction operation that extracts to the specified destination.
      tags: [Archives]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                destination:
                  type: string
                  description: Destination path (defaults to archive's directory)
            example:
              destination: extracted/backup-2024
      responses:
        '200':
          description: Archive extracted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  extracted_count:
                    type: integer
                    description: Number of files extracted
                  destination:
                    type: string
                    description: Destination path
              example:
                extracted_count: 42
                destination: local://extracted/backup-2024
        '404':
          description: Archive not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Invalid archive or extraction failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
